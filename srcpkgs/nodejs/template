# Template file for 'nodejs'
pkgname=nodejs
version=7.1.0
revision=1
wrksrc=node-v${version}
hostmakedepends="pkg-config python icu"
makedepends="zlib-devel python-devel icu-devel
 $(vopt_if ssl libressl-devel) $(vopt_if libuv libuv-devel)
 $(vopt_if http_parser http-parser-devel)"
depends="python"
short_desc="Evented I/O for V8 javascript"
maintainer="Enno Boland <gottox@voidlinux.eu>"
license="MIT"
homepage="http://nodejs.org/"
distfiles="${homepage}/dist/v${version}/node-v${version}.tar.gz"
checksum=595e7e2a37d1e0573044a90077bb12c0f750e5d8851899ffa74038238da9a983

build_options="ssl libuv http_parser"
desc_option_libuv="Enable shared libuv"
desc_option_http_parser="Enable shared http-parser"
build_options_default="libuv http_parser"

replaces="iojs>=0"

if [ -n "$CROSS_BUILD" ]; then
	# Cross compiling is currently broken
	broken=https://build.voidlinux.eu/builders/armv7l_builder/builds/28955/steps/shell_3/logs/stdio
fi

do_configure() {
	local _args

	export LD="$CXX"
	if [ "$CROSS_BUILD" ]; then
		case "$XBPS_TARGET_MACHINE" in
			arm*) _args="--dest-cpu=arm --without-snapshot" ;;
			aarch64*) _args="--dest-cpu=arm64 --without-snapshot" ;;
			*) msg_error "$pkgver: cannot be cross compiled for ${XBPS_TARGET_MACHINE}\n" ;;
		esac
	fi
	./configure --prefix=/usr --shared-zlib --with-intl=system-icu \
		$(vopt_if http_parser --shared-http-parser) \
		$(vopt_if ssl --shared-openssl) \
		$(vopt_if libuv --shared-libuv) ${_args}
}
do_build() {
	if [ "$CROSS_BUILD" ]; then
		make LD="$CXX" LDFLAGS+=-ldl ${makejobs} PORTABLE=1 V=1
	else
		make LD="$CXX" LDFLAGS+=-ldl ${makejobs} V=1
	fi
}
do_install() {
	make LD="$CXX" LDFLAGS+=-ldl DESTDIR="$DESTDIR" install
	vlicense LICENSE
	rm -r $DESTDIR/usr/include
}
